<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:fragment="head">
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Bootstrap -->
        <link href="assets/css/bootstrap.min.css" rel="stylesheet">
        <link href="assets/css/bootstrap-select.css" rel="stylesheet">
        <!-- font awesome for icons -->
        <link href="assets/css/font-awesome.min.css" rel="stylesheet">
        <!-- flex slider css -->
        <link href="assets/css/flexslider.css" rel="stylesheet" type="text/css" media="screen">
        <!-- animated css  -->
        <link href="assets/css/animate.css" rel="stylesheet" type="text/css" media="screen">
        <!-- Revolution Style-sheet -->
        <link href="assets/rs-plugin/css/settings.css" rel="stylesheet" type="text/css">
        <link href="assets/css/rev-style.css" rel="stylesheet" type="text/css">
        <!--owl carousel css-->
        <link href="assets/owl-carousel/dist/assets/owl.carousel.css" rel="stylesheet" type="text/css" media="screen">
        <link href="assets/owl-carousel/dist/assets/owl.theme.default.css" rel="stylesheet" type="text/css" media="screen">
        <!--mega menu -->
        <link href="assets/css/yamm.css" rel="stylesheet" type="text/css">
        <!--cube css-->
        <link href="assets/cubeportfolio/css/cubeportfolio.min.css" rel="stylesheet" type="text/css">
        <!-- custom css-->
        <link href="assets/css/components.css" rel="stylesheet" type="text/css" media="screen">
        <link href="assets/css/style.css" rel="stylesheet" type="text/css" media="screen">
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>

<body>
<div id="cabeceraMenu">

</div>
<br>
<section class="container">
        <div class="card p-4 pr-4 pl-4">
            <div class="mb-4">
                <h4>Configurar puntaje</h4>
            </div>
            <form class="needs-validation" id="myForm" novalidate>
                <div class="form-row mb-4">
                    <div class="col-md-7 mb-4">
                        <div class="form-group">
                            <select class="form-control" id="validation00" required>
                            </select>
                        </div>
                    </div>
                    <table class="table" id="myTable">
                        <thead>
                            <tr>
                                <th scope="col">N°</th>
                                <th scope="w-50">Curso</th>
                                <th scope="col">Buena</th>
                                <th scope="col">Mala</th>
                                <th scope="col">Vacía</th>
                            </tr>
                        </thead>
                    </table>
                </div>

                <div class="pr-3 pl-3 text-center">
                    <button class="btn btn-primary w-25" type="submit">Guardar</button>
                </div>
            </form>
        </div>
    </section>
<div id="Footer">

</div>

<script src="assets/js/jquery.min.js "></script>
<script src="assets/js/jquery-migrate.min.js "></script>
<!--bootstrap js plugin-->
    <script src="assets/js/bootstrap.min.js " type="text/javascript "></script>
    <!--easing plugin for smooth scroll-->
    <script src="assets/js/jquery.easing.1.3.min.js " type="text/javascript "></script>
    <!--sticky header-->
    <script type="text/javascript " src="assets/js/jquery.sticky.js "></script>
    <!--flex slider plugin-->
    <script src="assets/js/jquery.flexslider-min.js " type="text/javascript "></script>
    <!--parallax background plugin-->
    <script src="assets/js/jquery.stellar.min.js " type="text/javascript "></script>
    <!--digit countdown plugin-->
    <script src="assets/js/waypoints.min.js "></script>
    <!--digit countdown plugin-->
    <script src="assets/js/jquery.counterup.min.js " type="text/javascript "></script>
    <!--on scroll animation-->
    <script src="assets/js/wow.min.js " type="text/javascript "></script>
    <!--owl carousel slider-->
    <script src="assets/owl-carousel/dist/owl.carousel.min.js " type="text/javascript "></script>
    <!--popup js-->
    <script src="assets/js/jquery.magnific-popup.min.js " type="text/javascript "></script>
    <!--customizable plugin edit according to your needs-->
    <script src="assets/js/custom.js " type="text/javascript "></script>
    <script type="text/javascript " src="assets/rs-plugin/js/jquery.themepunch.tools.min.js "></script>
    <script type="text/javascript " src="assets/rs-plugin/js/jquery.themepunch.revolution.min.js "></script>
    <script type="text/javascript " src="assets/rs-plugin/videojs/video.js "></script>
    <script type="text/javascript " src="assets/js/revolution-custom.js "></script>
    <script src="assets/js/bootstrap-select.min.js " type="text/javascript "></script>
    <script src="assets/js/jquery-ui.min.js " type="text/javascript "></script>
    <script src="assets/cubeportfolio/js/jquery.cubeportfolio.min.js " type="text/javascript "></script>
    <script src="assets/js/cube-portfolio.js " type="text/javascript "></script>
    <script src="assets/js/pace.min.js " type="text/javascript "></script>
    <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <script type="text/javascript">
      $("#cabeceraMenu").load('cabeceraMenu.html');
      $("#Footer").load('Footer.html');

        var examenes = [];
        var cursos = [];
        var examenSeleccionado = {};

        $("#validation00").html('');
        $.get("http://localhost:8080/api/evaluaciones", function (data) {
            console.log('data');
            examenes = data;

            $.each(data, function (index, value) {
                if (index === 0) {
                    $("#validation00").append($('<option>', {
                        text: "Seleccionar examen",
                        value: ""
                    })

                    );
                }
                $("#validation00").append($('<option>', {
                    id: value.idevaluacion,
                    value: value.idevaluacion,
                    text: value.tituloevaluacion
                })

                );

            });
        }).fail(function (data) {
            alert("Error");
        });

        $.get("http://localhost:8080/api/cursos", function (data) {
            console.log('data');
            cursos = data;

        }).fail(function (data) {
            alert("Error");
        });

        $('#validation00').on('change', function () {
            examenSeleccionado = {}
            examenSeleccionado = examenes.filter(examen => examen.idevaluacion == this.value)[0];

            $('tbody').remove();
            if (examenSeleccionado) {

                $.get("http://localhost:8080/api/evaluacionpregunta/"+ this.value, function (data) {
                    
                    if (data.length) {
                        examenSeleccionado.preguntas = data.sort((a, b) => a.numeropregunta-b.numeropregunta);
                    }

                    for (let index = 0; index < examenSeleccionado.numeropreguntas; index++) {
                        $('#myTable').append(

                            `<tr>           
                                <th scope="row">${index + 1}</th>
                                <td class="w-50">
                                    <div class="form-group">
                                        <select class="form-control" id="curso-${index + 1}" required>
                                        </select>
                                    </div>
                                </td>
                                <td>
                                    <input type="number" class="form-control " id="puntaje-bueno-${index + 1}" >
                                </td>
                                <td>
                                    <input type="number" class="form-control " id="puntaje-malo-${index + 1}" >
                                </td>
                                <td>
                                    <input type="number" class="form-control " id="puntaje-vacio-${index + 1}" >
                                </td>
                            </tr>
                        `
                        );

                        $(`#curso-${index + 1}`).html('');
                        $.each(cursos, function (i, value) {
                            if (i === 0) {
                                $(`#curso-${index + 1}`).append($('<option>', {
                                    text: "Seleccionar curso",
                                    value: ""
                                }));
                            }
                            $(`#curso-${index + 1}`).append($('<option>', {
                                id: value.idcurso,
                                value: value.idcurso,
                                text: value.nombrecurso
                            }));
                        });

                        if (examenSeleccionado.preguntas) {
                            console.log(examenSeleccionado.preguntas[index].idcurso);
                            
                            $(`#curso-${index + 1}`).val(examenSeleccionado.preguntas[index].idcurso);
                            $(`#puntaje-bueno-${index + 1}`).val(examenSeleccionado.preguntas[index].puntajebuena);
                            $(`#puntaje-malo-${index + 1}`).val(examenSeleccionado.preguntas[index].puntajemala);
                            $(`#puntaje-vacio-${index + 1}`).val(examenSeleccionado.preguntas[index].puntajevacia);
                        } 
                    }

                }).fail(function (data) {
                    alert("Error");
                });
            }
        });

        (function () {
            'use strict';
            window.addEventListener('load', function () {
                // Fetch all the forms we want to apply custom Bootstrap validation styles to
                var forms = document.getElementsByClassName('needs-validation');
                // Loop over them and prevent submission
                var validation = Array.prototype.filter.call(forms, function (form) {
                    form.addEventListener('submit', function (event) {
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        } else {

                            for (let index = 0; index < examenSeleccionado.numeropreguntas; index++) {
                                var datos = {
                                    "idevaluacion": examenSeleccionado.idevaluacion,
                                    "numeropregunta": index + 1,
                                    "idcurso": $(`#curso-${index + 1} option:selected`).val(),
                                    "puntajebuena": $(`#puntaje-bueno-${index + 1}`).val(),
                                    "puntajemala": $(`#puntaje-malo-${index + 1}`).val(),
                                    "puntajevacia": $(`#puntaje-vacio-${index + 1}`).val(),
                                    "idpregunta": "",//pentiente correccion deberia ser campo vacio
                                };
                                //actualizacion si es que evaluacionpregunta ya ha sido registrado
                                
                                if(examenSeleccionado.preguntas) {
                                    datos.idevaluacionpregunta = examenSeleccionado.preguntas[index].idevaluacionpregunta;
                                }
                                $.ajax({
                                    url: "http://localhost:8080/api/evaluacionpregunta_reg",
                                    type: 'post',
                                    dataType: 'json',
                                    contentType: 'application/json',
                                    success: function (data) {

                                    },
                                    data: JSON.stringify(datos)
                                });
                            }
                            var dificultad = '';
                            switch (examenSeleccionado.gradodificultad) {
                                case 'F':
                                    dificultad = 'Fácil';
                                    break;
                                case 'N':
                                    dificultad = 'Normal';
                                    break;
                                case 'D':
                                    dificultad = 'Dificil';
                                    break;
                                case 'A':
                                    dificultad = 'Avanzado';
                                    break;
                                default:
                                    break;
                            }
                            alert("Se configuró examen correctamente");
                            $.get("http://localhost:8080/api/asignarpregunta/"+ $("#validation00").val(), function (data) {
                                var respuesta;
                                respuesta = 1;
                            }).fail(function (data) {
                                alert("Error");
                            });

                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();

    </script>
</body>

</html>